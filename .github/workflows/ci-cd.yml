# CI/CD workflow: checkout → build & push Docker → deploy with Helm
# Required secrets:
# - KUBE_CONFIG_DATA : Base64-encoded kubeconfig for your cluster
# - (optional) Use the built-in GITHUB_TOKEN for GHCR authentication

name: CI/CD

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # checkout:
  #   runs-on: arc-scale-set
  #   container:
  #     image: node:18-alpine
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Archive repository
  #       run: |
  #         tar -czf repo.tgz .

  #     - name: Upload repository artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: repo
  #         path: repo.tgz

  build:
    # needs: checkout
    runs-on: arc-scale-set
    environment: Dev
    container:
      image: docker/buildx-bin:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ Build image (NO PUSH)
      - name: Build image with Kaniko (no push)
        uses: aevea/action-kaniko@v0.11.0
        with:
          image: yourdockerhubuser/your-image
          tag: scan
          no_push: true
          dockerfile: Dockerfile
          context: .
          tar_path: image.tar

      # 2️⃣ Scan image
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          input: image.tar
          format: table
          severity: CRITICAL,HIGH
          exit-code: 1

      # 3️⃣ Push (เฉพาะถ้า scan ผ่าน)
      - name: Push image
        uses: aevea/action-kaniko@v0.11.0
        with:
          image: yourdockerhubuser/your-image
          tag: latest
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # - name: Build Image using Buildah
      #   run: |
      #     buildah bud \
      #       -t nodegoat:${{ github.sha }} \
      #       -f Dockerfile .
          
      # - name: Push to Registry
      #   run: |
      #     buildah push \
      #       --creds ${{ vars.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }} \
      #       nodegoat:${{ github.sha }} \
      #       docker://docker.io/${{ vars.DOCKERHUB_USERNAME }}/nodegoat:${{ github.sha }}

      # - name: Set image outputs
      #   id: setvars
      #   run: |
      #     echo "IMAGE_REPO=${{ vars.DOCKERHUB_USERNAME }}/nodegoat" >> $GITHUB_OUTPUT
      #     echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT

    # outputs:
    #   image_repo: ${{ steps.setvars.outputs.IMAGE_REPO }}
    #   image_tag: ${{ steps.setvars.outputs.IMAGE_TAG }}

  deploy:
    needs: build
    runs-on: arc-scale-set
    environment: Dev
    container:
      image: ${{ needs.build.outputs.image_repo }}:${{ needs.build.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # ติดตั้ง helm on-the-fly
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      # - name: Configure kubeconfig
      #   env:
      #     KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      #   run: |
      #     mkdir -p $HOME/.kube
      #     echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
      #     chmod 600 $HOME/.kube/config

      - name: Deploy Helm chart1
        env:
          IMAGE_REPO: ${{ vars.DOCKERHUB_USERNAME }}/nodegoat
          IMAGE_TAG: ${{ github.sha }}
        run: |
          helm upgrade --install nodegoat ./helm \
            --namespace nodegoat --create-namespace \
            --set webapp.nodegoat.image.repository=${IMAGE_REPO} \
            --set webapp.nodegoat.image.tag=${IMAGE_TAG} 

# helm install arc --namespace arc-systems --create-namespace oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller

# helm install arc-scale-set --namespace arc-runners --create-namespace --set githubConfigUrl="https://github.com/Endy74757/NodeGoat.git" --set githubConfigSecret.github_token="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" oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set

# kubectl create secret generic pre-defined-secret --namespace=arc-runners --from-literal=github_app_id=2529249 --from-literal=github_app_installation_id=100996931 --from-file=github_app_private_key=./arc-runner12.2025-12-23.private-key.pem